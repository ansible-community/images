---
- name: Build, test, and publish ansible-test container images
  hosts: all
  gather_facts: false
  vars_files:
    - images.yml
  pre_tasks:
    - name: Collect some facts
      setup:
        gather_subset:
          - '!all'
          - '!any'
          - date_time
          - distribution
          - dns
          - kernel
          - python
  tasks:
    - name: Build ansible-test images, run tests, and publish
      include_role:
        name: build-ansible-test-image
      vars:
        image_name: "{{ item.name }}"
        image_tag: "{{ item.tag }}"
        destination_image: "{{ destination_repository | default('quay.io/ansible-community/test-image') }}:{{ item.tag }}"
        build_script: "{{ item.script }}"
        image_python: "{{ item.python }}"
        run_tests: true
        remove_image: true
        publish_image: true
      loop: "{{ ansible_test_images_available }}"
